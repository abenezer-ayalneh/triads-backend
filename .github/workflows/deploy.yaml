name: Deploy to VPS

on:
    workflow_dispatch:
    push:
        branches:
            - main

jobs:
    deploy:
        runs-on: self-hosted
        environment: production

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '22.19.0'

            - name: Setup pnpm
              uses: pnpm/action-setup@v2
              with:
                  version: latest

            - name: Create .env file
              run: |
                  echo "APP_PORT=5000" >> .env
                  echo "CORS_ALLOWED_ORIGINS=https://triads.gametrix.org" >> .env
                  echo "THROTTLER_TTL=60000" >> .env
                  echo "THROTTLER_LIMIT=10" >> .env
                  echo "DATABASE_URL=postgresql://${{ secrets.POSTGRES_USER }}:${{ secrets.POSTGRES_PASSWORD }}@localhost:5434/triads?schema=public" >> .env

            - name: Install dependencies
              run: pnpm install

            - name: Configure database
              run: |
                  pnpm exec prisma migrate deploy
                  pnpm exec prisma generate

            - name: Build application
              run: pnpm build

            - name: Deploy application with PM2
              run: |
                  pm2 stop triads-backend || true
                  pm2 start ecosystem.config.js --env production
                  pm2 save
                  pm2 startup || true

            - name: Health check
              run: |
                  sleep 10
                  pm2 status
                  curl -f http://localhost:${{ secrets.APP_PORT }}/health || curl -f http://localhost:${{ secrets.APP_PORT }} || echo "Health check failed, but deployment completed"

            - name: Display deployment status
              run: |
                  echo "ðŸš€ Deployment completed successfully!"
                  echo "Application: lynx-backend"
                  echo "Environment: production"
                  echo "Port: ${{ secrets.APP_PORT }}"
                  pm2 list
